<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>vkontakte_api by 7even</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>vkontakte_api</h1>
        <p>Ruby-адаптер для ВКонтакте API</p>

        <p class="view"><a href="https://github.com/7even/vkontakte_api">View the Project on GitHub <small>7even/vkontakte_api</small></a></p>


        <ul>
          <li><a href="https://github.com/7even/vkontakte_api/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/7even/vkontakte_api/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/7even/vkontakte_api">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>Что это?</h2>

<p><code>vkontakte_api</code> - ruby-адаптер для ВКонтакте API. Библиотека позволяет вызывать методы API, получая их результаты в виде <code>Hashie::Mash</code> и массивов с ними (за исключением предикатных методов, возвращающих <code>true</code> или <code>false</code>); загружать файлы на сервера ВКонтакте, а также поддерживает авторизацию всех 3 типов, предоставляемых сервисом.</p>

<p>Методы из пространств имен (например, <code>friends.get</code>) реализованы в виде цепных вызовов, например <code>app.friends.get(fields: [:last_name, :first_name])</code>. В соответствии с соглашениями в языке ruby, названия методов пишутся в snake_case, в отличие от официальной документации, использующей camelCase-стиль.</p>

<h2>Как этим пользоваться?</h2>

<p>Можно использовать <code>vkontakte_api</code> как для авторизованных запросов (требующих авторизованного пользователя, типа <code>friends.get</code> или <code>groups.get</code> без параметра <code>:uid</code>), так и для неавторизованных (типа <code>users.get</code>).</p>

<h3>Неавторизованные запросы</h3>

<p>Некоторые методы API не требуют авторизации, для их вызова достаточно создать объект <code>VkontakteApi::Client</code> и адресовать методы ему:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'vkontakte_api'</span>
<span class="vi">@app</span> <span class="o">=</span> <span class="no">VkontakteApi</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span>
<span class="vi">@app</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre>
</div>


<h3>Авторизованные запросы</h3>

<p>Большинство методов API требуют предварительной авторизации, в результате которой приложение получает токен доступа. Для этой задачи можно использовать сторонние решения наподобие <a href="https://github.com/intridea/omniauth">omniauth</a> и <a href="https://github.com/mamantoha/omniauth-vkontakte">omniauth-vkontakte</a>, либо воспользоваться механизмом авторизации, встроенным в <code>vkontakte_api</code>. В первом случае полученный токен нужно просто передать при создании клиента (<code>VkontakteApi::Client.new(token)</code>), а встроенную авторизацию рассмотрим подробнее.</p>

<h4>Авторизация</h4>

<p>Схема получения токена доступа следующая:</p>

<ul>
<li>редиректим пользователя на ВКонтакте, там он подтверждает запрошенные права доступа</li>
<li>ВК редиректит его обратно в наше приложение, передавая в параметрах код</li>
<li>запрашиваем у ВК токен доступа, используя код, полученный шагом ранее</li>
<li>с токеном можно вызывать методы ВКонтакте API</li>
</ul><p>Первое, что нужно сделать - зарегистрировать приложение на vk.com. Идем <a href="http://vk.com/editapp?act=create">сюда</a>, вводим название приложения, его домен и тип (для данного примера - веб-сайт). После создания на странице редактирования приложения можно найти ID приложения и защищенный ключ.</p>

<p>Далее необходимо указать в конфигурации <code>vkontakte_api</code> полученные данные, а также URL для редиректа на 2 шаге. Это делается следующим образом:</p>

<div class="highlight">
<pre><span class="no">VkontakteApi</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">app_id</span>       <span class="o">=</span> <span class="s1">'123'</span>      <span class="c1"># ID приложения</span>
  <span class="n">config</span><span class="o">.</span><span class="n">app_secret</span>   <span class="o">=</span> <span class="s1">'AbCdE654'</span> <span class="c1"># защищенный ключ</span>
  <span class="n">config</span><span class="o">.</span><span class="n">redirect_uri</span> <span class="o">=</span> <span class="s1">'http://example.com/oauth/callback'</span>
<span class="k">end</span>
</pre>
</div>


<p>Далее перебрасываем пользователя на ВК для получения прав на доступ к его данным. URL для редиректа возвращается методом <code>VkontakteApi.authorization_url</code>, в его опциях можно указать требуемые <a href="http://vk.com/developers.php?oid=-17680044&amp;p=Application_Access_Rights">права доступа</a>:</p>

<div class="highlight">
<pre><span class="no">VkontakteApi</span><span class="o">.</span><span class="n">authorization_url</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span> <span class="o">[</span><span class="ss">:friends</span><span class="p">,</span> <span class="ss">:photos</span><span class="o">]</span><span class="p">)</span>
</pre>
</div>


<p>При редиректе пользователя обратно в приложение будет передан параметр <code>code</code>:</p>

<pre><code>http://example.com/oauth/callback?code=7a6fa4dff77a228eeda56603b8f53806c883f011c40b72630bb50df056f6479e52a
</code></pre>

<p>Теперь, когда у нас есть код, можно получить токен доступа. За это отвечает метод <code>VkontakteApi.authorize</code> - он получает токен и создает клиент, готовый к вызову методов, требующих авторизации:</p>

<div class="highlight">
<pre><span class="vi">@vk</span> <span class="o">=</span> <span class="no">VkontakteApi</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span><span class="p">)</span>
<span class="vi">@vk</span><span class="o">.</span><span class="n">friends</span><span class="o">.</span><span class="n">get</span>
</pre>
</div>


<h4>Использование API</h4>

<p>Как уже говорилось, методы из пространств имен вызываются цепочкой, а названия пишутся в snake_case стиле. Параметры всех методов являются именованными, и передаются в виде хэша; при этом если необходимо передать список, разделенный запятыми, его можно оформить как массив из строк или символов - конкатенация произойдет автоматически. Возвращаемые значения - как правило, объекты <code>Hashie::Mash</code> (разновидность хэша, позволяющая доступ к элементам через методы, соответствующие ключам этого хэша) и содержащие их массивы.</p>

<div class="highlight">
<pre><span class="vi">@app</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">get</span> <span class="c1"># =&gt; [1, 31022447]</span>

<span class="n">friends</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">friends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fields</span><span class="p">:</span> <span class="o">[</span><span class="ss">:uid</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:screen_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="o">]</span><span class="p">)</span>
<span class="n">friends</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">uid</span>         <span class="c1"># =&gt; "1"</span>
<span class="n">friends</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">first_name</span>  <span class="c1"># =&gt; "Павел"</span>
<span class="n">friends</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">screen_name</span> <span class="c1"># =&gt; "durov"</span>
<span class="n">friends</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">last_name</span>   <span class="c1"># =&gt; "Дуров"</span>
</pre>
</div>


<p>Более подробно о вызове методов, загрузке файлов, авторизации, логгировании и настройке гема можно почитать в <a href="https://github.com/7even/vkontakte_api#readme">README</a>.</p>

<p>Пример интеграции <code>vkontakte_api</code> с rails-приложением можно посмотреть <a href="http://vkontakte-on-rails.herokuapp.com">здесь</a>; исходники проекта находятся <a href="https://github.com/7even/vkontakte_on_rails">тут</a>.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/7even">7even</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-31422612-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>